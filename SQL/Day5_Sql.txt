--stored procedure with exception handling and transaction management

create table Products
(ProductId int primary key,
ProdName varchar(50),
Price int,
QtyAvailable int)

--populate some records
insert into Products values(100,'Laptops',54000,100),
(101,'Desktops',32000,50),
(102,'Tablet',21000,75),
(103,'Mobile',25000,50)

create table ProductSales(ProductSalesId int primary key,
ProductId int references Products(ProductId),
QtySold int)

create or alter procedure spSellProduct 
@productid int, @QtyToSell int
as 
begin
 --first we need to check the stock availability for the product that we want to sell
 declare @stockavailable int
 select @stockavailable=QtyAvailable from Products where productid = @productid
  --we need to throw an error when the stock is less than the qty to sell
  --RaiseError is a system function that takes 3 parameters as below
  --Raiserror('Error Message', ErrorSeverity, Errorstate)
   if(@stockavailable < @QtyToSell)
   begin
    Raiserror('Not Enough Stock',16,21)
   end
   --if stock is more then 
  else
   begin
    --we need to start a transaction
	begin transaction
	  -- first update the qtyavailable in products table
	  update Products set QtyAvailable=(QtyAvailable-@QtyToSell)
	  where ProductId=@productid
	  --next we need to insert one record of the sale made in Productsales table
	  --in order to insert productsalesid automatically we can use a logic as below
	  declare @maxid int
	  select @maxid=case
	   when max(productsalesid) is null then 0
	   else max(productsalesid)
	   end
	   from ProductSales
	   --increment @maxid by 1, so that we dont get a primary key violation
	   set @maxid=@maxid+1
	   --now we can insert a record into productsales table
	   insert into ProductSales values(@maxid,@productid,@QtyToSell)
	   --the @@Error returns a non-zero value if there is an error, otherwise 0
	   if(@@ERROR <> 0)
	   begin
	    Rollback transaction
		print 'Rolling back the transaction..'
	   end
	   else
	    begin
	     Commit Transaction
	     print ' Comitted the transaction'
		end
 end
end

-- execute the above proc
select * from products
select * from ProductSales
exec spSellProduct 101,20

select max(productsalesid) from ProductSales

--eg 2 error handling in a procedure
create or alter procedure Errhandler1
as
begin
  begin try
    select Empname + Salary from employee where empid=5
  end try
  begin catch
    print 'cannot concatenate varchar with float'
  end catch
end

create or alter procedure Errhandler1
as
begin
  begin try
    select Empname + Salary from employee where empid=5
  end try
  begin catch
    --print 'cannot concatenate varchar with float'
	--Raiserror(15600,11,1,'invalid Operation in procedure')
	raiserror(15600,11,2)
	--throw 51000,'Problem',15
  end catch
end
--can execute a procedure without the exec/execute command as below
errhandler1

--To add a user defined message 

exec sp_addmessage 51000,12,'MyErrorMessage'

--to view all the errors

select * from sys.messages where message_id=15600

---cursors
declare @empname varchar(max),
@sal float
--declaring a cursor
declare mycur1 cursor
for select empname,salary from employee
--open the created cursor
open mycur1
--fetch the first record
fetch next  from mycur1 into @empname,@sal
 --iterate and fetch data till the end of the cursor
 while @@FETCH_STATUS=0
  begin
   if(@sal>12300)
     begin
	   print @empname + ' earns : '+ cast(@sal as varchar(max))
	  
	 end
    else
	 begin
	  print @empname + ' earns less than 12300'
	   --update employee set salary =salary +200 where empname=@empname
	   print 'Salary Updated in table'
	 end
  fetch next from mycur1 into @empname,@sal
 end
 close mycur1
 deallocate mycur1

 insert into employee values(200,'Banurekha',12350,'Female',4,000008)

 select * from employee

 --static cursors
 declare @ename varchar(max),
@esal float
--declaring a cursor
declare mycur2 cursor static
for select empname,salary from employee
--open the created cursor
open mycur2
--fetch the first record
fetch relative 5 from mycur2 into @ename,@esal
 --iterate and fetch data till the end of the cursor
 while @@FETCH_STATUS=0
  begin
   if(@esal>12300)
     begin
	   print @ename + ' earns : '+ cast(@esal as varchar(max))
	  
	 end
    else
	 begin
	  print @ename + ' earns less than 12300'
	   --update employee set salary =salary +200 where empname=@empname
	  -- print 'Salary Updated in table'
	 end
  fetch  relative 2 from mycur2 into @ename,@esal
  --fetch prior from mycur2 into @ename,@esal
 end
 close mycur2
 deallocate mycur2

 